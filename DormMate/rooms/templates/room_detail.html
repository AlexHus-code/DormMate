{% extends "base.html" %}
{% load static %}

{% block title %}Комната №{{ room.number }}{% endblock title %}

{% block css_files %}
<link rel="stylesheet" href="{% static "rooms/base.css" %}">
{% endblock css_files %}

{% block content %}
<div class="room-container">
    <h1 class="room-title">Комната №{{ room.number }} на {{ room.floor }} этаже</h1>

    <div class="room-content-flex">
        <!-- Левая колонка -->
        <div class="room-details">
            <div class="room-section">
                <h2>Проживающие:</h2>
                <ul class="student-list">
                    {% for resident in residents %}
                        <li>
                            {{ resident.username }}
                            {% if user.is_authenticated and user.role == "admin" %}
                                <form action="{% url 'remove-resident' room.number resident.id %}" method="post" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Удалить пользователя из комнаты?')">Удалить</button>
                                </form>
                            {% endif %}
                        </li>
                    {% empty %}
                        <li>Пока никто не проживает</li>
                    {% endfor %}
                </ul>

                {% if user.is_authenticated and user.role == "admin" %}
                    <div class="room-section" style="margin-top: 20px;">
                        <h3>Добавить пользователя:</h3>
                        <form method="post" action="{% url 'add-resident' room.number %}">
                            {% csrf_token %}
                            <select name="user_id" required>
                                <option value="" disabled selected>Выберите пользователя</option>
                                {% for u in all_users %}
                                    <option value="{{ u.id }}">{{ u.username }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-primary">Добавить</button>
                        </form>
                    </div>
                {% endif %}
            </div>

            <div class="room-section">
                <p><strong>Цена за месяц:</strong> {{ room.price }} ₴</p>
                <p><strong>Описание:</strong> {{ room.about }}</p>
                <p><strong>Свободно:</strong> {{ available_slots }} из {{ total_slots }} мест</p>
            </div>

            {% if user.is_authenticated %}
                {% if user.role == "student" %}
                    {% if has_pending_application %}
                        <div class="room-full">
                            <p>Вы уже подали заявку на поселение. Ожидайте рассмотрения.</p>
                        </div>
                    {% else %}
                        {% if available_slots > 0 %}
                            <div class="room-available">
                                <p>В комнате есть свободные места</p>
                                <a href="{% url 'room-form' room.number %}" class="apply-link">Подать заявление на поселение</a>
                            </div>
                        {% else %}
                            <div class="room-full">
                                <p>В комнате нет свободных мест</p>
                            </div>
                        {% endif %}
                    {% endif %}
                {% elif user.role == "admin" %}
                    <div class="room-full">
                        <p>Вы вошли как администратор.</p>
                    </div>
                {% endif %}
            {% else %}
                <div class="room-full">
                    <p>Чтобы подать заявление, необходимо <a href="{% url 'register' %}" class="room-link">зарегистрироваться</a> и войти в систему.</p>
                </div>
            {% endif %}

            {% if user.is_authenticated and user.role == "admin" %}
                <form action="{% url 'delete-room' room.number %}" method="post" onsubmit="return confirm('Вы уверены, что хотите удалить эту комнату?');">
                    {% csrf_token %}
                    <button type="submit" class="delete-button">Удалить комнату</button>
                </form>
            {% endif %}
        </div>

        <!-- Правая колонка -->
        <div class="room-image">
            {% if room.image %}
                <img src="{{ room.image.url }}" alt="Изображение комнаты {{ room.number }}" class="room-img">
            {% else %}
                <img src="{% static 'rooms/default.jpg' %}" alt="Нет изображения" class="room-img">
            {% endif %}
        </div>
    </div>
</div>
{% endblock content %}
